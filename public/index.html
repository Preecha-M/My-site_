<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real-Time Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="flex items-center justify-center h-screen bg-gray-100">
    <div class="text-center">
      <img
        src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZXR4Ym9nc3lweWhuNDFpbmw0d2tseHVkOWdzaTNnZnNncjh3aHh6NCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/MDJ9IbxxvDUQM/giphy.gif"
        alt="Centered Photo"
        class="mx-auto mb-6 rounded-lg shadow-lg"
      />

      <!-- Chat Box -->
      <div
        id="chat-box"
        class="w-full p-4 mb-6 bg-white border rounded-lg max-w-md h-64 overflow-y-scroll"
      >
        <!-- Messages will appear here -->
      </div>

      <!-- Text Input -->
      <textarea
        id="user-message"
        rows="3"
        placeholder="à¸žà¸´à¸¡à¸žà¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸•à¸£à¸‡à¸™à¸µà¹‰à¸„à¹‰à¸²à¸šà¸šà¸šà¸š..."
        class="w-full p-2 border rounded-lg"
      ></textarea>
      <button
        id="send-message"
        class="mt-4 px-6 py-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600"
      >
        à¸ªà¹ˆà¸‡à¹€à¸¥à¸¢à¸¢à¸¢à¸¢à¸¢
      </button>

      <!-- Instruction Text -->
      <div class="mt-6 text-lg font-bold text-gray-700">à¸¢à¸´à¹‰à¸¡à¸«à¸™à¹ˆà¸­à¸¢à¸„à¹‰à¸²à¸šà¸šà¸šà¸š</div>

      <!-- Yes and No Buttons -->
      <div class="mt-4">
        <button
          id="yes-button"
          class="px-6 py-2 text-white bg-green-500 rounded-lg hover:bg-green-600"
        >
          à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸¢à¸¢
        </button>
        <button
          id="no-button"
          class="px-6 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600"
        >
          à¸¡à¹ˆà¸²à¸¢à¸¢à¸¢à¸¢
        </button>
      </div>

      <!-- Status Display -->
      <div id="status" class="mt-4 text-lg font-bold text-gray-700"></div>

      <!-- Clear Storage Button (moved to the bottom) -->
      <div class="mt-6">
        <button
          id="clear-storage"
          class="px-6 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600"
        >
          Clear Chat & Status
        </button>
      </div>
    </div>

    <script>
        const CLEAR_PASSWORD = "admin123"; // Password for clearing storage
      
        // Select elements by their IDs
        const chatBox = document.getElementById("chat-box");
        const userMessage = document.getElementById("user-message");
        const sendMessageButton = document.getElementById("send-message");
        const yesButton = document.getElementById("yes-button");
        const noButton = document.getElementById("no-button");
        const statusDisplay = document.getElementById("status");
        const clearStorageButton = document.getElementById("clear-storage");
      
        // Set to store displayed messages
        const displayedMessages = new Set();
      
        // Load chat messages and status from localStorage on page load
        function loadFromLocalStorage() {
          const savedMessages = JSON.parse(localStorage.getItem("messages")) || [];
          const savedStatus = localStorage.getItem("status") || "";
      
          // Display saved messages
          savedMessages.forEach((message) => {
            displayMessage(message);
          });
      
          // Display saved status
          if (savedStatus) {
            statusDisplay.textContent = savedStatus;
          }
        }
      
        // Save messages to localStorage
        function saveMessagesToLocalStorage(message) {
          const messages = JSON.parse(localStorage.getItem("messages")) || [];
          messages.push(message);
          localStorage.setItem("messages", JSON.stringify(messages));
        }
      
        // Function to display a message in the chat box
        function displayMessage(message) {
          if (!displayedMessages.has(message)) {
            displayedMessages.add(message);
      
            const messageDiv = document.createElement("div");
            messageDiv.textContent = message;
            messageDiv.className = "p-2 mb-2 bg-gray-200 rounded-lg text-left";
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to the latest message
      
            // Save message to localStorage
            saveMessagesToLocalStorage(message);
          }
        }
      
        // Function to send a message
        async function sendMessage() {
          const message = userMessage.value.trim();
          if (!message) return;
      
          try {
            await fetch("http://localhost:8080/send", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message }),
            });
            userMessage.value = ""; // Clear the input field
          } catch (error) {
            console.error("Error sending message:", error);
          }
        }
      
        // Function to poll for new messages
        async function pollMessages() {
          try {
            const response = await fetch("http://localhost:8080/poll");
            const data = await response.json();
            if (data.messages && data.messages.length > 0) {
              data.messages.forEach((msg) => displayMessage(msg));
            }
          } catch (error) {
            console.error("Error polling messages:", error);
          } finally {
            // Continue polling after the response
            setTimeout(pollMessages, 1000);
          }
        }
      
        // Event listener for send button
        sendMessageButton.addEventListener("click", sendMessage);
      
        // Start polling for messages
        pollMessages();
      
        // Handle Yes button click
        yesButton.addEventListener("click", () => {
          const status = "à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸¢à¸¢ ðŸ˜Š";
          statusDisplay.textContent = status;
          statusDisplay.classList.add("text-green-600");
      
          // Save status to localStorage
          localStorage.setItem("status", status);
        });
      
        // Handle No button click
        noButton.addEventListener("click", () => {
          const randomX = Math.floor(
            Math.random() * (window.innerWidth - noButton.offsetWidth)
          );
          const randomY = Math.floor(
            Math.random() * (window.innerHeight - noButton.offsetHeight)
          );
          noButton.style.position = "absolute";
          noButton.style.left = `${randomX}px`;
          noButton.style.top = `${randomY}px`;
        });
      
        // Handle Clear Storage button click
        clearStorageButton.addEventListener("click", () => {
          const password = prompt("Enter the password to clear chat and status:");
          if (password === CLEAR_PASSWORD) {
            localStorage.clear(); // Clear all localStorage data
            chatBox.innerHTML = ""; // Clear chat box
            statusDisplay.textContent = ""; // Clear status
            alert("Chat and status have been cleared!");
          } else {
            alert("Incorrect password. Action canceled.");
          }
        });
      
        // Load data from localStorage when the page loads
        loadFromLocalStorage();
      </script>
      
  </body>
</html>
